---
title: "R Notebook"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include = FALSE, error=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      comment = "#>",
                      collapse = TRUE,
                      error = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = 'center'
                      )
```

## Calculate VLP using Hagedorn-Brown (no heat transfer)
* vertical well

```{r rows.print=30}
library(rNodal)

# Example from C.13 in Brown
# P2 (pressure at end point is given). 
# The question is: what is the length of the tubing.
# P2 = 1000 psia

input.example.C13 <- setWellInput(
                        field.name = "HAGBR.MOD", 
                        well.name = "Brown_C13", 
                        depth.wh = 0, depth.bh = 2670, 
                        diam.in = 1.995, 
                        GLR = 500, 
                        liq.rt = 1000, 
                        wcut = 0.6, 
                        thp = 500, 
                        tht = 120, 
                        bht = 150, 
                        API = 22, 
                        gas.sg = 0.65, 
                        wat.sg = 1.07, 
                        if.tens = 30)


well.model <- setVLPmodel(vlp.model = "hagbr.mod", 
                          segments = 11, 
                          tol = 0.000001)

# c13_output <- runVLP(well.input = input.example.C13, well.model)
# c13_output
```

## VLP calculation with Heat transfer calculations
* Vertical well
* Angle constant

It will grab only few variables from the VLP final table above.
     
     c("depth", "dL", "pres", "temp")

```{r rows.print=30}
# calculate the fluid temperature in the well
# input: deviation survey and well calculated parameters: uses new functions: 
#        get_well_parameters
#        rNodal:::temp.gradient

library(rNodal)

# the standard well input
# Note that U (heat transfer coefficient is added at the end)
input.example.C13 <- setWellInput(
                        field.name = "HAGBR.MOD",
                        well.name = "Brown_C13", 
                        depth.wh = 0, depth.bh = 2670, 
                        diam.in = 1.995, 
                        GLR = 500, 
                        liq.rt = 1000, 
                        wcut = 0.6, 
                        thp = 500, 
                        tht = 120, 
                        bht = 150, 
                        API = 22, 
                        gas.sg = 0.65, 
                        wat.sg = 1.07,
                        U = 17)

# well model
well.model <- setVLPmodel(vlp.model = "hagbr.mod", 
                          segments = 11, 
                          tol = 0.000001)

# run VLP only to get the initial part of the table
# TODO: maybe we need to add a function that only return the simple stuff
# such as depth, dL
vlp_output <- runVLP(well.input = input.example.C13, 
                     well.model)

names(vlp_output)
```

```{r}
# get only the variables we need for heat transfer. But what we really want 
# is the deviation survey: MD, TVD
vlp_output <- vlp_output[, c("depth", "dL", "pres", "temp")] 
```

```{r}
# get initial well parameters including basic calculations
well_parameters <- get_well_parameters(input.example.C13)
names(well_parameters)
```

```{r}
# heat capacity is a scalar from basic calculations
well_parameters$cp.avg
```


```{r}
# temp.gradient calculates the fluid temperature coming from the wellbore
# inputs are depth, dL, pres, temp plus basic calculations
rNodal:::temp.gradient(vlp_output, well_parameters)  
```


> Notes.

> 1. We don't need VLP calculations for the function temp_gradient(). We only need the depth table which is only one line.

> 2. We don't need either the whole `well_parameters` list. 
from well_parameters we need: U, angle, depth.bh, depth.wh, bht, tht, diam.ft, mass.rate, cp.avg. All are scalars

> 3. We should separate the well inputs from the initial calculations instead of merging them in `well_parameters`. It would be clearer and more usable. Have more sense.

> 4. We should create a function that only returns the depth points. Also another one that adds the ground temperature. The standalone function could be called from different scripts.

> 5. The calculations in temp.gradient are independent of pressure.

> 6. We could suply the table of depths and fluid temperature to the VLPControl function and let the algorithm calculate the average temperature from the new table that considers heat transfer.

> 7. Avoid using `temp.grad` which only considers the earth temperature not the fluid's. The temperature gradient should not be a scalar but a vector as calculated by `temp.gradient`.


## Same as above but calculating fluid temperature. Angle constant

Added new input parameters:

    .  U = double 1= 8
    .  oil.cp = double 1= 0.53
    .  gas.cp = double 1= 0.5
    .  wat.cp = double 1= 1
    
Added new calculated objects:

    .  mass.rt = double 1= 378585
    .  mass.rate = double 1= 378585
    .  cp.avg = double 1= 0.67667


```{r rows.print=30}
# this tests if the new function get_well_parameters() returns all what's needed for heat transfer
library(rNodal)

well_table <- runVLP(well.input = input.example.C13, 
                     well.model)[, c("depth", "dL", "pres", "temp")]   

input.example.C13 <- setWellInput(field.name = "HAGBR.MOD",
                                    well.name = "Brown_C13", 
                                    depth.wh = 0, depth.bh = 2670, diam.in = 1.995, 
                                    GLR = 500, liq.rt = 1000, wcut = 0.6, 
                                    thp = 500, tht = 120, bht = 150, 
                                    API = 22, gas.sg = 0.65, wat.sg = 1.07,
                                  U = 17)
# input.example.C13
# getBasicCalcs(input.example.C13)
well_params <- get_well_parameters(input.example.C13)
Hmisc::list.tree(well_params, maxcomp = 40)

# temp.gradient calculates the fluid temperature coming from the wellbore
rNodal:::temp.gradient(well_table, well_parameters)    
```

## old version using spelled-out parameters

```{r rows.print=30}
# this in an old version where all well parameters had to be spelled out
# parameters necessary to calculate the fluid temperature
well_table <- runVLP(well.input = input.example.C13, 
                     well.model)[, c("depth", "dL", "pres", "temp")] 

theta   <-  pi /2
diam.in <- 1.995
diam.ft <- diam.in / 12
tht     <- 120
bht     <- 150
depth   <- 2670
ge      <- (bht - tht) / depth
mass.rate <- 228145
U <-  17
# U <- 4
cp.avg <- (0.53 + 0.5 + 1 ) / 3

# calculate dT/dx for the well
rNodal:::temp.fluid(well_table, theta, depth, bht, tht, U, cp.avg, diam.ft, mass.rate)
# we don't want all parameters spelled out      ^   ^      ^     ^      ^      ^     
```



## APPENDIX

### previous data (unit testing)

    p30 = 1043.8745
    p30 = 1043.8793
    p30 = 1045.1834
    p30 = 1043.1091 (after using p.avg and t.avg)
    p30 = 1043.1094 (after using p.avg, t.avg, p0 = p.calc)


### where the HDF5 file is

[link to hdf5 file](C:\Users\msfz751\AppData\Local\Temp\RtmpEbxvPR\file40c0446c2f7.h5)

[hdf5 in inst/extdata](I:\src\rNodal\inst\extdata\brown_c13.h5)

[h5](C:\Users\msfz751\AppData\Local\Temp\RtmpM3UF3e\file526835c54c20.h5)


### results for unit testing

      MD      TVD     Pres  Temp
       0       0     500.0  135.8
     242.7   242.7   563.1  137.9
     485.5	 485.5	 627.5  139.8
     728.2	 728.2	 693.1	141.6
     970.9	 970.9	 759.8	143.4
    1213.6	1213.6	 827.6	144.9
    1456.4	1456.4	 896.5	146.3
    1699.1	1699.1	 966.4	147.6
    1941.8	1941.8	1037.3	148.6
    2184.5	2184.5	1109.3	149.3
    2427.3	2427.3	1182.2	149.8
    2670.0	2670.0	1255.9	150.0
    
    
```{r rows.print=20}
# convert text table to dataframe in preparation for unit test
results_unit_test <- "
      MD      TVD     Pres  Temp
       0       0     500.0  135.8
     242.7   242.7   563.1  137.9
     485.5	 485.5	 627.5  139.8
     728.2	 728.2	 693.1	141.6
     970.9	 970.9	 759.8	143.4
    1213.6	1213.6	 827.6	144.9
    1456.4	1456.4	 896.5	146.3
    1699.1	1699.1	 966.4	147.6
    1941.8	1941.8	1037.3	148.6
    2184.5	2184.5	1109.3	149.3
    2427.3	2427.3	1182.2	149.8
    2670.0	2670.0	1255.9	150.0
"    

library(readr)
read_table2(results_unit_test, col_names = TRUE)
```
    
        
        
```{r}
library(rNodal)

# separate the columns with tabs
well_as_text <- "
    MD  TVD    
       0	     0   
     242.7   242.7
     485.5   485.5
     728.2   728.2
     970.9   970.9
    1213.6  1213.6
    1456.4	1456.4
    1699.1	1699.1
    1941.8	1941.8
    2184.5	2184.5
    2427.3	2427.3
    2670.0	2670.0
"

deviation_survey <- set_deviation_survey(well_as_text)
deviation_survey
```

```{r}
# rNodal:::calc_angle_deviation_survey(deviation_survey)
```


# Specifying geothermal gradient

```{r rows.print=30}
library(rNodal)
# vertical well

geothermal_data <- c("
  TVD   temp
  0     120
  2670  150
")

input.example.C13 <- setWellInput(
                        field.name = "HAGBR.MOD", 
                        well.name = "Brown_C13", 
                        depth.wh = 0, 
                        depth.bh = 2670, 
                        diam.in = 1.995, 
                        GLR = 500, 
                        liq.rt = 1000, 
                        wcut = 0.6, 
                        thp = 500, 
                        tht = 120, 
                        bht = 150, 
                        API = 22, 
                        gas.sg = 0.65, 
                        wat.sg = 1.07, 
                        if.tens = 30,
                        )


well.model <- setVLPmodel(vlp.model = "hagbr.mod", 
                          segments = 11, 
                          tol = 0.000001)

runVLP(well.input = input.example.C13, well.model)
# c13_output
```


```{r}
geothermal_data <- c("
  TVD   temp
  0     120
  2670  150
")


geotherm_df <- read.table(header = TRUE, text = geothermal_data)
geotherm_df
```

